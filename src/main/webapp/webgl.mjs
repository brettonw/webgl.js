export let LogLevel=function(){let e=Object.create(null);e.TRACE=0;e.INFO=1;e.WARNNG=2;e.ERROR=3;let n=e.ERROR;e.set=function(t){n=t};let r=["TRC","INF","WRN","ERR"];e.say=function(t,e){if(t>=n){console.log(r[t]+": "+e)}};e.trace=function(t){this.say(e.TRACE,t)};e.info=function(t){this.say(e.INFO,t)};e.warn=function(t){this.say(e.WARNNG,t)};e.error=function(t){this.say(e.ERROR,t)};return e}();export let Utility=function(){let e=Object.create(null);const n=Math.PI*2;let r=e.unwind=function(t,e){t-=Math.floor(t/e)*e;while(t>=e){t-=e}while(t<0){t+=e}return t};e.unwindRadians=function(t){return e.unwind(t,n)};e.unwindDegrees=function(t){return e.unwind(t,360)};e.degreesToRadians=function(t){return r(t/180,2)*Math.PI};e.cos=function(t){return Math.cos(e.degreesToRadians(t))};e.sin=function(t){return Math.sin(e.degreesToRadians(t))};e.tan=function(t){return Math.tan(e.degreesToRadians(t))};e.radiansToDegrees=function(t){return r(t,n)/Math.PI*180};e.uppercase=function(t){return t[0].toUpperCase()+t.slice(1)};e.lowercase=function(t){return t[0].toLowerCase()+t.slice(1)};e.flatten=function(t){let n=[];for(let e of t){for(let t of e){n.push(t)}}return n};e.fixNum=function(t,e){e=typeof e!=="undefined"&&e!=null?e:7;return Number.parseFloat(t.toFixed(e))};e.padNum=function(t,e,n){n=n||"0";t=t+"";return t.length>=e?t:new Array(e-t.length+1).join(n)+t};e.defaultValue=function(t,e){return t=typeof t!=="undefined"&&t!=null?t:e};e.defaultFunction=function(t,e){return t=typeof t!=="undefined"&&t!=null?t:e()};e.reverseMap=function(e){let n=Object.create(null);for(let t in e){n[e[t]]=t}return n};return e}();let FloatN=function(dim){let _=Object.create(null);_.create=function(){return new Float32Array(dim)};eval(function(){let e="_.copy = function (from, to) {\n";e+="to = (typeof to !== 'undefined') ? to : _.create ();\n";for(let t=0;t<dim;++t){e+="to["+t+"] = from["+t+"];\n"}e+="return to;\n";e+="};\n";return e}());eval(function(){let e="_.point = function (from, to) {\n";e+="to = (typeof to !== 'undefined') ? to : _.create ();\n";let n=dim-1;for(let t=0;t<n;++t){e+="to["+t+"] = from["+t+"];\n"}e+="to["+n+"] = 1;\n";e+="return to;\n";e+="};\n";return e}());eval(function(){let e="_.vector = function (from, to) {\n";e+="to = (typeof to !== 'undefined') ? to : _.create ();\n";let n=dim-1;for(let t=0;t<n;++t){e+="to["+t+"] = from["+t+"];\n"}e+="to["+n+"] = 0;\n";e+="return to;\n";e+="};\n";return e}());eval(function(){let e="_.dot = function (left, right) {\n";e+="return (left[0] * right[0])";for(let t=1;t<dim;++t){e+="\n + (left["+t+"] * right["+t+"])"}e+=";\n";e+="};\n";return e}());_.normSq=function(t){return _.dot(t,t)};_.norm=function(t){let e=_.normSq(t);return e>0?Math.abs(e-1)>1e-6?Math.sqrt(e):1:0};_.normalize=function(t,e){let n=_.norm(t);return Math.abs(n-1)>1e-6?_.scale(t,1/n,e):_.copy(t,e)};eval(function(){let e="_.add = function (left, right, to) {\n";e+="to = (typeof to !== 'undefined') ? to : _.create ();\n";for(let t=0;t<dim;++t){e+="to["+t+"] = left["+t+"] + right["+t+"];\n"}e+="return to;\n";e+="};\n";return e}());eval(function(){let e="_.subtract = function (left, right, to) {\n";e+="to = (typeof to !== 'undefined') ? to : _.create ();\n";for(let t=0;t<dim;++t){e+="to["+t+"] = left["+t+"] - right["+t+"];\n"}e+="return to;\n";e+="};\n";return e}());eval(function(){let e="_.scale = function (from, scale, to) {\n";e+="to = (typeof to !== 'undefined') ? to : _.create ();\n";for(let t=0;t<dim;++t){e+="to["+t+"] = from["+t+"] * scale;\n"}e+="return to;\n";e+="};\n";return e}());eval(function(){let e="_.fixNum = function (from, precision, to) {\n";e+="to = (typeof to !== 'undefined') ? to : _.create ();\n";for(let t=0;t<dim;++t){e+="to["+t+"] = Utility.fixNum (from["+t+"], precision);\n"}e+="return to;\n";e+="};\n";return e}());eval(function(){let e="_.minor = function (from) {\n";e+="let minorIndex = 0, minorValue = from[minorIndex], nextValue;\n";for(let t=1;t<dim;++t){e+="nextValue = from["+t+"]; ";e+="if (minorValue > nextValue) { minorIndex = "+t+"; minorValue = nextValue;};\n"}e+="return minorIndex;\n";e+="};\n";return e}());eval(function(){let e="_.major = function (from) {\n";e+="let majorIndex = 0, majorValue = from[majorIndex], nextValue;\n";for(let t=1;t<dim;++t){e+="nextValue = from["+t+"]; ";e+="if (majorValue < nextValue) { majorIndex = "+t+"; majorValue = nextValue;};\n"}e+="return majorIndex;\n";e+="};\n";return e}());eval(function(){let e="_.str = function (from) {\n";e+="return '(' + from[0]";for(let t=1;t<dim;++t){e+="\n + ', ' +  + from["+t+"].toFixed (7)"}e+=" + ')';\n";e+="};\n";return e}());_.equals=function(t,e){return _.str(t)===_.str(e)};return _};export let Float2=function(){let n=FloatN(2);n.perpendicular=function(t,e){e=e=typeof e!=="undefined"&&e!=null?e:n.create();e[0]=t[1];e[1]=-t[0];return e};n.cross=function(t,e){return t[0]*e[1]-t[1]*e[0]};return n}();export let Float3=function(){let r=FloatN(3);r.cross=function(t,e,n){n=n=typeof n!=="undefined"&&n!=null?n:r.create();n[0]=t[1]*e[2]-t[2]*e[1];n[1]=t[2]*e[0]-t[0]*e[2];n[2]=t[0]*e[1]-t[1]*e[0];return n};return r}();export let Float4=function(){return FloatN(4)}();let FloatNxN=function(dim){let _=Object.create(null);let _FloatN=FloatN(dim);let size=dim*dim;let index=_.index=function(t,e){return t*dim+e};let defineTo=function(t){t=typeof t!=="undefined"&&t!=null?t:"to";return t+" = (typeof "+t+" !== 'undefined') ? "+t+" : _.create ();\n"};_.create=function(){return new Float32Array(size)};eval(function(){let r="_.copy = function (from, to) {\n";r+=defineTo();for(let n=0;n<dim;++n){for(let e=0;e<dim;++e){let t=index(n,e);r+="to["+t+"] = from["+t+"]; "}r+="\n"}r+="return to;\n";r+="};\n";return r}());eval(function(){let n="_.identity = function (to) {\n";n+=defineTo();for(let e=0;e<dim;++e){for(let t=0;t<dim;++t){n+="to["+index(e,t)+"] = "+(e===t?1:0)+"; "}n+="\n"}n+="return to;\n";n+="};\n";return n}());_.IDENTITY=_.identity();eval(function(){let n="_.transpose = function (from, to) {\n";n+=defineTo();for(let e=0;e<dim;++e){for(let t=0;t<dim;++t){n+="to["+index(e,t)+"] = from["+index(t,e)+"]; "}n+="\n"}n+="return to;\n";n+="};\n";return n}());eval(function(){let n=function(e,n){let r="(left["+index(e,0)+"] * right["+index(0,n)+"])";for(let t=1;t<dim;++t){r+=" + (left["+index(e,t)+"] * right["+index(t,n)+"])"}r+=";\n";return r};let r="_.multiply = function (left, right, to) {\n";r+=defineTo();for(let e=0;e<dim;++e){for(let t=0;t<dim;++t){r+="to["+index(e,t)+"] = "+n(e,t)}}r+="return to;\n";r+="};\n";return r}());_.chain=function(...n){let r=n[0];for(let e=1,t=n.length;e<t;++e){let t=n[e];r=_.multiply(r,t)}return r};eval(function(){let e=dim-1;let n="_.scale = function (scale, to) {\n";n+="scale = Array.isArray(scale) ? scale : Array("+e+").fill(scale);\n";n+="to = _.identity (to);\n";for(let t=0;t<e;++t){n+="to["+index(t,t)+"] = scale["+t+"]; "}n+="\n";n+="return to;\n";n+="};\n";return n}());eval(function(){let e=dim-1;let n="_.translate = function (translate, to) {\n";n+="to = _.identity (to);\n";for(let t=0;t<e;++t){n+="to["+index(e,t)+"] = translate["+t+"]; "}n+="\n";n+="return to;\n";n+="};\n";return n}());eval(function(){let e=function(e){let n="'(' + from["+index(e,0)+"]";for(let t=1;t<dim;++t){n+=" + ', ' + from["+index(e,t)+"]"}n+=" + ')'";return n};let n="_.str = function (from) {\n";n+="return ";n+=e(0);for(let t=1;t<dim;++t){n+=" + ', ' + "+e(t)}n+=";\n";n+="};\n";return n}());return _};export let Float4x4=function(){let t=4;let A=FloatNxN(t);A.inverse=function(t,e){e=e=typeof e!=="undefined"&&e!=null?e:A.create();let n=t[0]*t[5]-t[1]*t[4],r=t[0]*t[6]-t[2]*t[4],i=t[9]*t[14]-t[10]*t[13],a=t[9]*t[15]-t[11]*t[13],o=t[10]*t[15]-t[11]*t[14],s=t[0]*t[7]-t[3]*t[4],u=t[1]*t[6]-t[2]*t[5],l=t[1]*t[7]-t[3]*t[5],f=t[2]*t[7]-t[3]*t[6],c=t[8]*t[13]-t[9]*t[12],d=t[8]*t[14]-t[10]*t[12],h=t[8]*t[15]-t[11]*t[12],m=1/(n*o-r*a+s*i+u*h-l*d+f*c);e[0]=(t[5]*o-t[6]*a+t[7]*i)*m;e[1]=(-t[1]*o+t[2]*a-t[3]*i)*m;e[2]=(t[13]*f-t[14]*l+t[15]*u)*m;e[3]=(-t[9]*f+t[10]*l-t[11]*u)*m;e[4]=(-t[4]*o+t[6]*h-t[7]*d)*m;e[5]=(t[0]*o-t[2]*h+t[3]*d)*m;e[6]=(-t[12]*f+t[14]*s-t[15]*r)*m;e[7]=(t[8]*f-t[10]*s+t[11]*r)*m;e[8]=(t[4]*a-t[5]*h+t[7]*c)*m;e[9]=(-t[0]*a+t[1]*h-t[3]*c)*m;e[10]=(t[12]*l-t[13]*s+t[15]*n)*m;e[11]=(-t[8]*l+t[9]*s-t[11]*n)*m;e[12]=(-t[4]*i+t[5]*d-t[6]*c)*m;e[13]=(t[0]*i-t[1]*d+t[2]*c)*m;e[14]=(-t[12]*u+t[13]*r-t[14]*n)*m;e[15]=(t[8]*u-t[9]*r+t[10]*n)*m;return e};A.preMultiply=function(t,e,n){n=n=typeof n!=="undefined"&&n!=null?n:Float4.create();let r=t[0],i=t[1],a=t[2],o=t[3];n[0]=e[0]*r+e[4]*i+e[8]*a+e[12]*o;n[1]=e[1]*r+e[5]*i+e[9]*a+e[13]*o;n[2]=e[2]*r+e[6]*i+e[10]*a+e[14]*o;n[3]=e[3]*r+e[7]*i+e[11]*a+e[15]*o;return n};A.postMultiply=function(t,e,n){n=n=typeof n!=="undefined"&&n!=null?n:Float4.create();let r=e[0],i=e[1],a=e[2],o=e[3];n[0]=t[0]*r+t[1]*i+t[2]*a+t[3]*o;n[1]=t[4]*r+t[5]*i+t[6]*a+t[7]*o;n[2]=t[8]*r+t[9]*i+t[10]*a+t[11]*o;n[3]=t[12]*r+t[13]*i+t[14]*a+t[15]*o;return n};A.rotateX=function(t){let e=A.identity();e[5]=e[10]=Math.cos(t);e[9]=-(e[6]=Math.sin(t));return e};A.rotateY=function(t){let e=A.identity();e[0]=e[10]=Math.cos(t);e[2]=-(e[8]=Math.sin(t));return e};A.rotateZ=function(t){let e=A.identity();e[0]=e[5]=Math.cos(t);e[4]=-(e[1]=Math.sin(t));return e};let s=function(t,e,n,r,i,a,o){o=o=typeof o!=="undefined"&&o!=null?o:A.create();let s=e-t,u=r-n,l=a-i;o[0]=i*2/s;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=i*2/u;o[6]=0;o[7]=0;o[8]=(e+t)/s;o[9]=(r+n)/u;o[10]=-(a+i)/l;o[11]=-1;o[12]=0;o[13]=0;o[14]=-2*a*i/l;o[15]=0;return o};A.frustum=s;A.perspective=function(t,e,n,r,i){let a=n*Math.tan(Utility.degreesToRadians(t*.5));let o=a*e;return s(-o,o,-a,a,n,r,i)};A.orthographic=function(t,e,n,r,i,a,o){o=o=typeof o!=="undefined"&&o!=null?o:A.create();let s=e-t,u=r-n,l=a-i;o[0]=2/s;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=2/u;o[6]=0;o[7]=0;o[8]=0;o[9]=0;o[10]=-2/l;o[11]=0;o[12]=-(t+e)/s;o[13]=-(r+n)/u;o[14]=-(a+i)/l;o[15]=1;return o};let o=function(t,e,n,r){let i=A.create();i[0]=t[0];i[1]=t[1];i[2]=t[2];i[3]=0;i[4]=e[0];i[5]=e[1];i[6]=e[2];i[7]=0;i[8]=n[0];i[9]=n[1];i[10]=n[2];i[11]=0;i[12]=r[0];i[13]=r[1];i[14]=r[2];i[15]=1;return A.inverse(i)};A.viewMatrix=o;let u=function(t,e,n){n=Float3.normalize(Utility.defaultValue(n,[0,1,0]));let r=Float3.normalize(e);let i=Float3.normalize(Float3.cross(n,r));let a=Float3.normalize(Float3.cross(r,i));return o(i,a,r,t)};A.lookFrom=u;A.lookFromAt=function(t,e,n){return u(t,Float3.subtract(t,e),n)};A.lookAt=function(t,e,n,r,i){let a=t/Math.tan(Utility.degreesToRadians(e*.5));let o=Float3.add(r,Float3.scale(n,a/Float3.norm(n)));return u(o,n,i)};A.rotateZAxisTo=function(t,e){e=Utility.defaultFunction(e,function(){return[0,1,0]});t=Float3.normalize(t);let n=Float3.normalize(Float3.cross(e,t));let r=Float3.normalize(Float3.cross(t,n));let i=A.create();i[0]=n[0];i[1]=n[1];i[2]=n[2];i[3]=0;i[4]=r[0];i[5]=r[1];i[6]=r[2];i[7]=0;i[8]=t[0];i[9]=t[1];i[10]=t[2];i[11]=0;i[12]=0;i[13]=0;i[14]=0;i[15]=1;return i};A.rotateXAxisTo=function(t,e){e=Utility.defaultFunction(e,function(){return[0,1,0]});t=Float3.normalize(t);let n=Float3.normalize(Float3.cross(t,e));let r=Float3.normalize(Float3.cross(n,t));let i=A.create();i[0]=t[0];i[1]=t[1];i[2]=t[2];i[3]=0;i[4]=r[0];i[5]=r[1];i[6]=r[2];i[7]=0;i[8]=n[0];i[9]=n[1];i[10]=n[2];i[11]=0;i[12]=0;i[13]=0;i[14]=0;i[15]=1;return i};return A}();export let WebGL2=function(){let s=Object.create(null);let e=s.ClassBase=function(){let t=Object.create(null);t.new=function(t){let e=Object.create(this);if("construct"in e){t=typeof t!=="undefined"&&t!=null?t:Object.create(null);e.construct(t)}return e};return t}();s.CLASS_NAME_REQUIRED="CLASS_NAME_REQUIRED";s.CLASS_NAME_GENERATED="CLASS_NAME_GENERATED";s.CLASS_NAME_OPTIONAL="CLASS_NAME_OPTIONAL";let r=s.ClassNamed=function(n){n=typeof n!=="undefined"&&n!=null?n:s.CLASS_NAME_OPTIONAL;let r=Object.create(e);let i=Object.create(null);let a=0;let o=function(t,e){if(typeof t!=="undefined"&&t!=null){if(!(t in i)||e){return t}throw"Duplicate name ("+t+")"}switch(n){case s.CLASS_NAME_REQUIRED:throw"Name is required";case s.CLASS_NAME_GENERATED:return"id"+Utility.padNum(++a,5);case s.CLASS_NAME_OPTIONAL:return null}};r.new=function(t,e){t=typeof t!=="undefined"&&t!=null?t:Object.create(null);if((e=o(e,t.replace=typeof t.replace!=="undefined"&&t.replace!=null?t.replace:false))!=null)t.name=e;let n=Object.getPrototypeOf(r).new.call(this,t);if(e!=null){n.name=e;i[e]=n}return n};r.get=function(t){return i[t]};r.getName=function(){return"name"in this?this.name:"node"};r.getIndex=function(){return i};r.forEach=function(n){for(let e in i){let t=i[e];n(t)}};return r};let u=s.OnReady=function(){let n=Object.create(null);n.construct=function(t,e){this.scope=t;this.callback=e;return this};n.notify=function(t){this.callback.call(this.scope,t)};n.new=function(t,e){return Object.create(n).construct(t,e)};return n}();let t=s.PointerTracker=function(){let t=Object.create(e);let n={};let c=0;let r=function(){};let i=function(t){t.stopPropagation();t.preventDefault();return false};let a=function(u){let l=n[u.currentTarget.id];let f=l.events;if(u.pointerId in f){let r=f[u.pointerId];f[u.pointerId]=u;let e=l.element.getBoundingClientRect();let i=function(t){return[(t.clientX-e.left)/e.width,(t.clientY-e.top)/-e.height,0]};let t=function(t){return[0,0,(t.clientY-e.top)/-e.height]};let n=function(t){return[0,0,0]};let a=function(){let t=o(u);let e=o(r);let n=Float3.subtract(t,e);if(Float3.normSq(n)>0){l.onReady.notify(n)}};let o;let s=Object.keys(f);switch(s.length){case 1:o=[n,i,t,n,n,n][u.buttons];a();break;case 2:{let t=i(f[s[0]]);let e=i(f[s[1]]);let n=Float3.normSq(Float3.subtract(t,e));if(c>0){let t=n>c?1:-1;console.log("response = "+t);l.onReady.notify([0,0,t])}c=n;break}default:o=n;a();break}}return i(u)};let o=function(t){let e=n[t.currentTarget.id];delete e.events[t.pointerId];r();return i(t)};let s=function(t){let e=n[t.currentTarget.id];e.events[t.pointerId]=t;c=0;r();return i(t)};let u=function(t){let e=n[t.currentTarget.id];e.onReady.notify(Float3.copy([0,0,-t.deltaY]));return i(t)};const l=37;const f=38;const d=39;const h=40;let m=function(t){let e=n[t.currentTarget.id];switch(t.keyCode){case l:e.onReady.notify([-e.stepSize,0,0]);break;case f:e.onReady.notify([0,e.stepSize,0]);break;case d:e.onReady.notify([e.stepSize,0,0]);break;case h:e.onReady.notify([0,-e.stepSize,0]);break;default:e.onReady.notify([0,0,0]);break}return i(t)};t.construct=function(t){n[t.elementId]=this;this.onReady=t.onReady;this.stepSize=t.stepSize=typeof t.stepSize!=="undefined"&&t.stepSize!=null?t.stepSize:.05;this.events={};let e=this.element=document.getElementById(t.elementId);e.addEventListener("pointerdown",s,false);e.addEventListener("pointermove",a,false);e.addEventListener("pointerup",o,false);e.addEventListener("pointercancel",o,false);e.addEventListener("pointerleave",o,false);e.addEventListener("pointerout",o,false);e.addEventListener("keydown",m,false);e.addEventListener("wheel",u,false);e.addEventListener("contextmenu",i,false);e.focus()};return t}();let n=function(){let t=Object.create(e);t.element=function(t){this[t]=document.getElementById(t);return this};t.elements=function(...e){for(let t of e){this.element(t)}return this};t.all=function(){return this};return t}();let i=s.RollingStats=function(){let t=Object.create(e);t.construct=function(t){this.count=Utility.defaultValue(t.count,10);if("fill"in t){this.fill=t.fill}this.reset()};t.update=function(t){this.sum+=t;if(this.history.length<this.count){this.history.push(t)}else{this.sum-=this.history[this.current];this.history[this.current]=t;this.current=(this.current+1)%this.count}let n=this.sum/this.history.length;let r=Number.POSITIVE_INFINITY;let i=Number.NEGATIVE_INFINITY;let a=0;for(let e of this.history){i=Math.max(e,i);r=Math.min(e,r);let t=e-n;a+=t*t}a/=this.count;return{min:r,max:i,avg:n,var:a,std:Math.sqrt(a)}};t.reset=function(){this.history=[];this.sum=0;if("fill"in this){for(let t=0;t<this.count;++t){this.history.push(this.fill);this.sum+=this.fill}}this.current=0};return t}();let l;s.getContext=function(){return l};let a=s.Render=function(){let t=Object.create(e);t.construct=function(e){let t=document.getElementById(e.canvasDivId);let n=document.createElement("canvas");t.appendChild(n);l=this.context=n.getContext("webgl2",{preserveDrawingBuffer:true});let r=window.devicePixelRatio=typeof window.devicePixelRatio!=="undefined"&&window.devicePixelRatio!=null?window.devicePixelRatio:1;let i=function(t){let e=t[0].target;l.viewportWidth=l.canvas.width=e.clientWidth*r;l.viewportHeight=l.canvas.height=e.clientHeight*r;l.viewport(0,0,l.viewportWidth,l.viewportHeight);l.canvas.style.width=e.clientWidth+"px";l.canvas.style.height=e.clientHeight+"px"};new ResizeObserver(i).observe(t);let a=f.new().addLoaders(d.new("https://webgl.irdev.us/shaders/@.glsl").addVertexShaders("basic").addFragmentShaders(["basic","basic-texture","color","overlay","rgb","texture","vertex-color"]));if("loaders"in e){a.addLoaders(e.loaders)}let o=this;a.go(u.new(null,function(t){y.make();F.make();M.make();g.make();S.make();N.makeN(2);N.makeN(3);N.makeN(5);m.new({},"basic");m.new({vertexShader:"basic"},"basic-texture");m.new({vertexShader:"basic"},"color");m.new({vertexShader:"basic"},"overlay");m.new({vertexShader:"basic"},"rgb");m.new({vertexShader:"basic"},"texture");m.new({vertexShader:"basic"},"vertex-color");if(typeof e.onReady!=="undefined"){e.onReady.notify(o)}}))};t.save=function(t){let e="image/png";let n=this.context.canvas.toDataURL(e);let r=document.createElement("a");r.download=t+".png";r.href=n;r.dataset.downloadurl=[e,r.download,r.href].join(":");document.body.appendChild(r);r.click();document.body.removeChild(r)};return t}();let o=s.Loader=function(){let t=Object.create(e);t.construct=function(t){this.items=[];this.onReady=u.new(this,this.finish);return this};t.addItem=function(t,e,n){n.onReady=this.onReady;let r={type:t,name:e,parameters:n};this.items.push(r);return this};t.finish=function(t){if(t===this.pendingItem){delete this.pendingItem;this.next()}else{}};t.go=function(t){this.onFinishedAll=t=typeof t!=="undefined"&&t!=null?t:{notify:function(t){}};this.next()};t.next=function(){if(this.items.length>0){let t=this.items.shift();this.pendingItem=t.type.new(t.parameters,t.name)}else{this.onFinishedAll.notify(this)}};return t}();let f=s.LoaderList=function(){let t=Object.create(e);t.construct=function(t){this.items=[];this.onReady=u.new(this,this.finish);return this};t.addLoaders=function(...e){if(Array.isArray(e[0])){e=e[0]}for(let t of e){this.items.push(t)}return this};t.finish=function(t){if(t===this.pendingItem){delete this.pendingItem;this.next()}else{}};t.next=function(){if(this.items.length>0){let t=this.items.shift();this.pendingItem=t;t.go(this.onReady)}else{this.onFinishedAll.notify(this)}};t.go=function(t){this.onFinishedAll=t=typeof t!=="undefined"&&t!=null?t:{notify:function(t){}};this.next()};return t}();let c=s.LoaderPath=function(){let r=Object.create(o);r.construct=function(t){Object.getPrototypeOf(r).construct.call(this,t);this.type=t.type;this.path=t.path;return this};r.addItems=function(t,n){t=Array.isArray(t)?t:Array(1).fill(t);for(let e of t){let t=Object.assign(Object.create(null),n,{url:this.path.replace("@",e)});Object.getPrototypeOf(r).addItem.call(this,this.type,e,t)}return this};return r}();let d=s.LoaderShader=function(){let e=Object.create(c);e.construct=function(t){return Object.getPrototypeOf(e).construct.call(this,{type:h,path:t})};let n=function(e,n){e=Array.isArray(e)?e:Array(1).fill(e);let r=[];for(let t of e){r.push(n+"-"+t)}return r};const r=35633;e.addVertexShaders=function(t){return Object.getPrototypeOf(e).addItems.call(this,n(t,"vertex"),{type:r})};const i=35632;e.addFragmentShaders=function(t){return Object.getPrototypeOf(e).addItems.call(this,n(t,"fragment"),{type:i})};return e}();let h=s.Shader=function(){let t=r();t.construct=function(e){if(typeof e.type==="undefined")throw"Shader type Required";if(typeof e.url==="undefined")throw"Shader URL Required";let n=this;let r=new XMLHttpRequest;r.onload=function(t){if(r.status===200){let t=l.createShader(e.type);l.shaderSource(t,r.responseText);l.compileShader(t);if(!l.getShaderParameter(t,l.COMPILE_STATUS)){}else{n.compiledShader=t}}if(typeof e.onReady!=="undefined"){e.onReady.notify(n)}};r.open("GET",e.url);r.send()};return t}();let m=s.Program=function(){let e=r(s.CLASS_NAME_REQUIRED);e.POSITION_ATTRIBUTE="POSITION_ATTRIBUTE";e.NORMAL_ATTRIBUTE="NORMAL_ATTRIBUTE";e.TEXTURE_ATTRIBUTE="TEXTURE_ATTRIBUTE";e.COLOR_ATTRIBUTE="COLOR_ATTRIBUTE";e.MODEL_MATRIX_ATTRIBUTE="MODEL_MATRIX_ATTRIBUTE";let t;e.construct=function(t){t.vertexShader="vertex-"+(t.vertexShader=typeof t.vertexShader!=="undefined"&&t.vertexShader!=null?t.vertexShader:t.name);t.fragmentShader="fragment-"+(t.fragmentShader=typeof t.fragmentShader!=="undefined"&&t.fragmentShader!=null?t.fragmentShader:t.name);if(!("attributeMapping"in t)){t.attributeMapping={POSITION_ATTRIBUTE:"inputPosition",NORMAL_ATTRIBUTE:"inputNormal",TEXTURE_ATTRIBUTE:"inputTexture",COLOR_ATTRIBUTE:"inputColor",MODEL_MATRIX_ATTRIBUTE:"inputModelMatrix"}}if(!("parameterMapping"in t)){t.parameterMapping={MODEL_MATRIX_PARAMETER:"modelMatrix",VIEW_MATRIX_PARAMETER:"viewMatrix",PROJECTION_MATRIX_PARAMETER:"projectionMatrix",CAMERA_POSITION:"cameraPosition",OUTPUT_ALPHA_PARAMETER:"outputAlpha",TEXTURE_SAMPLER:"textureSampler",MODEL_COLOR:"modelColor",AMBIENT_LIGHT_COLOR:"ambientLightColor",AMBIENT_CONTRIBUTION:"ambientContribution",LIGHT_DIRECTION:"lightDirection",LIGHT_COLOR:"lightColor",DIFFUSE_CONTRIBUTION:"diffuseContribution",SPECULAR_CONTRIBUTION:"specularContribution",SPECULAR_EXPONENT:"specularExponent"}}this.currentShape=null;let i=this.program=l.createProgram();l.attachShader(i,h.get(t.vertexShader).compiledShader);l.attachShader(i,h.get(t.fragmentShader).compiledShader);l.bindAttribLocation(i,0,t.attributeMapping.POSITION_ATTRIBUTE);l.linkProgram(i);if(!l.getProgramParameter(i,l.LINK_STATUS)){}l.useProgram(i);let e=t.parameterMapping;let a=Utility.reverseMap(e);let o=this.standardParameterMapping=Object.create(null);for(let r=0,t=l.getProgramParameter(i,l.ACTIVE_UNIFORMS);r<t;r++){let e=A.new(i,r);let t=e.name;let n="set"+Utility.uppercase(t);this[n]=function(t){e.set(t);return this};if(t in a){o[a[t]]=n}}let r=Utility.reverseMap(t.attributeMapping);let s=this.attributes=Object.create(null);for(let n=0,t=l.getProgramParameter(i,l.ACTIVE_ATTRIBUTES);n<t;n++){let t=l.getActiveAttrib(i,n);let e=t.name;if(e in r){s[r[e]]=b.new(i,t)}}};e.setStandardUniforms=function(e){let n=this.standardParameterMapping;for(let t in e){if(t in n){this[n[t]](e[t])}}return this};let n=function(t,e,n){if(e in t.attributes){l.bindBuffer(l.ARRAY_BUFFER,n);t.attributes[e].bind()}return t};e.bindPositionAttribute=function(t){return n(this,e.POSITION_ATTRIBUTE,t)};e.bindNormalAttribute=function(t){return n(this,e.NORMAL_ATTRIBUTE,t)};e.bindTextureAttribute=function(t){return n(this,e.TEXTURE_ATTRIBUTE,t)};e.bindColorAttribute=function(t){return n(this,e.COLOR_ATTRIBUTE,t)};e.bindModelMatrixAttribute=function(t){return n(this,e.MODEL_MATRIX_ATTRIBUTE,t)};e.unbindAttributes=function(){for(let t in this.attributes){this.attributes[t].unbind()}};e.getCurrentProgram=function(){return t};e.use=function(){if(t!==this){if(t){t.unbindAttributes()}t=this;l.useProgram(this.program);this.currentShape=null}return this};e.useShape=function(t){if(this.currentShape!==t){this.currentShape=t;return true}return false};return e}();let A=function(){let n=Object.create(null);n.construct=function(t,e){let n=l.getActiveUniform(t,e);this.name=n.name;this.type=n.type;this.location=l.getUniformLocation(t,n.name);if(this.type===l.SAMPLER_2D){this.textureIndex="nextTextureIndex"in t?t.nextTextureIndex:0;t.nextTextureIndex=this.textureIndex+1}else{}return this};n.set=function(t){switch(this.type){case 5124:l.uniform1i(this.location,t);break;case 35667:l.uniform2iv(this.location,t);break;case 35668:l.uniform3iv(this.location,t);break;case 35669:l.uniform4iv(this.location,t);break;case 5126:l.uniform1f(this.location,t);break;case 35664:l.uniform2fv(this.location,t);break;case 35665:l.uniform3fv(this.location,t);break;case 35666:l.uniform4fv(this.location,t);break;case 35674:l.uniformMatrix2fv(this.location,false,t);break;case 35675:l.uniformMatrix3fv(this.location,false,t);break;case 35676:l.uniformMatrix4fv(this.location,false,t);break;case 35678:l.activeTexture(l.TEXTURE0+this.textureIndex);l.bindTexture(l.TEXTURE_2D,T.get(t).texture);l.uniform1i(this.location,this.textureIndex);break}};n.new=function(t,e){return Object.create(n).construct(t,e)};return n}();let b=function(){let n=Object.create(null);n.construct=function(t,e){this.name=e.name;this.type=e.type;this.location=l.getAttribLocation(t,this.name);switch(this.type){case 5124:this.bind=function(){l.enableVertexAttribArray(this.location);l.vertexAttribPointer(this.location,1,l.INT,false,0,0)};break;case 35667:this.bind=function(){l.enableVertexAttribArray(this.location);l.vertexAttribPointer(this.location,2,l.INT,false,0,0)};break;case 35668:this.bind=function(){l.enableVertexAttribArray(this.location);l.vertexAttribPointer(this.location,3,l.INT,false,0,0)};break;case 35669:this.bind=function(){l.enableVertexAttribArray(this.location);l.vertexAttribPointer(this.location,4,l.INT,false,0,0)};break;case 5126:this.bind=function(){l.enableVertexAttribArray(this.location);l.vertexAttribPointer(this.location,1,l.FLOAT,false,0,0)};break;case 35664:this.bind=function(){l.enableVertexAttribArray(this.location);l.vertexAttribPointer(this.location,2,l.FLOAT,false,0,0)};break;case 35665:this.bind=function(){l.enableVertexAttribArray(this.location);l.vertexAttribPointer(this.location,3,l.FLOAT,false,0,0)};break;case 35666:this.bind=function(){l.enableVertexAttribArray(this.location);l.vertexAttribPointer(this.location,4,l.FLOAT,false,0,0)};break;case 35676:this.bind=function(){const e=16;const n=4*e;for(let t=0;t<4;++t){const r=this.location+t;const i=t*e;l.enableVertexAttribArray(r);l.vertexAttribPointer(r,4,l.FLOAT,false,n,i);l.vertexAttribDivisor(r,1)}};break}return this};n.unbind=function(){l.disableVertexAttribArray(this.location)};n.new=function(t,e){return Object.create(n).construct(t,e)};return n}();let T=s.Texture=function(){let t=r(s.CLASS_NAME_REQUIRED);let i;t.construct=function(t){i=typeof i!=="undefined"&&i!=null?i:function(){return l.getExtension("EXT_texture_filter_anisotropic")}();t.anisotropicFiltering=Math.min(l.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT),"anisotropicFiltering"in t?t.anisotropicFiltering:4);if(typeof t.url==="undefined")throw"Texture URL Required";let e=this.texture=l.createTexture();let n=new Image;n.crossOrigin="anonymous";let r=this;n.onload=function(){l.bindTexture(l.TEXTURE_2D,e);l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,n);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR);if("generateMipMap"in t&&t.generateMipMap===true){l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR_MIPMAP_LINEAR);l.texParameterf(l.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,t.anisotropicFiltering);l.generateMipmap(l.TEXTURE_2D)}else{l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR)}l.bindTexture(l.TEXTURE_2D,null);if(typeof t.onReady!=="undefined"){t.onReady.notify(r)}};n.src=t.url};return t}();let R=s.Node=function(){let t=r(s.CLASS_NAME_GENERATED);t.construct=function(t){let e=1;let n=2;let r=4;let i=8;let a=0;if("transform"in t){this.transform=t.transform;a+=e}if("state"in t){this.state=t.state;a+=n}if("shape"in t){this.shape=_.get(t.shape);if(typeof this.shape==="undefined"){}this.instanceTransforms=this.shape.createInstanceTransforms(t.instance);a+=r}this.enabled=t.enabled=typeof t.enabled!=="undefined"&&t.enabled!=null?t.enabled:true;if(!("children"in t)||t.children!==false){this.children=[];a+=i}let o=function(t){return this};this.traverse=[o,o,o,o,function(t){if(this.enabled){this.draw(t)}return this},function(t){if(this.enabled){t.MODEL_MATRIX_PARAMETER=Float4x4.multiply(this.transform,t.MODEL_MATRIX_PARAMETER);this.draw(t)}return this},function(t){if(this.enabled){this.state(t);this.draw(t)}return this},function(t){if(this.enabled){this.state(t);t.MODEL_MATRIX_PARAMETER=Float4x4.multiply(this.transform,t.MODEL_MATRIX_PARAMETER);this.draw(t)}return this},function(n){if(this.enabled){let e=n.MODEL_MATRIX_PARAMETER;for(let t of this.children){n.MODEL_MATRIX_PARAMETER=e;t.traverse(n)}}return this},function(n){if(this.enabled){let e=Float4x4.multiply(this.transform,n.MODEL_MATRIX_PARAMETER);for(let t of this.children){n.MODEL_MATRIX_PARAMETER=e;t.traverse(n)}}return this},function(n){if(this.enabled){this.state(n);let e=n.MODEL_MATRIX_PARAMETER;for(let t of this.children){n.MODEL_MATRIX_PARAMETER=e;t.traverse(n)}}return this},function(n){if(this.enabled){this.state(n);let e=Float4x4.multiply(this.transform,n.MODEL_MATRIX_PARAMETER);for(let t of this.children){n.MODEL_MATRIX_PARAMETER=e;t.traverse(n)}}return this},function(n){if(this.enabled){let e=n.MODEL_MATRIX_PARAMETER;this.draw(n);for(let t of this.children){n.MODEL_MATRIX_PARAMETER=e;t.traverse(n)}}return this},function(n){if(this.enabled){let e=n.MODEL_MATRIX_PARAMETER=Float4x4.multiply(this.transform,n.MODEL_MATRIX_PARAMETER);this.draw(n);for(let t of this.children){n.MODEL_MATRIX_PARAMETER=e;t.traverse(n)}}return this},function(n){if(this.enabled){this.state(n);let e=n.MODEL_MATRIX_PARAMETER;this.draw(n);for(let t of this.children){n.MODEL_MATRIX_PARAMETER=e;t.traverse(n)}}return this},function(n){if(this.enabled){this.state(n);let e=n.MODEL_MATRIX_PARAMETER=Float4x4.multiply(this.transform,n.MODEL_MATRIX_PARAMETER);this.draw(n);for(let t of this.children){n.MODEL_MATRIX_PARAMETER=e;t.traverse(n)}}return this}][a];return this};t.removeChild=function(e){let t=this.children.findIndex(t=>t.name===e);if(t>=0){this.children.splice(t,1);return true}return false};t.addChild=function(t){if("children"in this){this.children.push(t);t.parent=this}else{}return this};t.draw=function(t){m.getCurrentProgram().setStandardUniforms(t);this.shape.instanceTransforms=this.instanceTransforms;this.shape.draw()};t.traverse=function(t){return this};t.getTransform=function(t){let e="transform"in this?this.transform:Float4x4.IDENTITY;if(typeof t!=="undefined"&&this==t||!("parent"in this)){return e}else{return Float4x4.multiply(e,this.parent.getTransform(t))}};return t}();let _=s.Shape=function(){let t=r(s.CLASS_NAME_REQUIRED);t.construct=function(t){let e=t.buffers();let n=function(t,e,n){let r=l.createBuffer();l.bindBuffer(t,r);l.bufferData(t,e,l.STATIC_DRAW);r.itemSize=n;r.numItems=e.length/n;return r};const r=1;const i=2;const a=4;const o=8;let s=0;if("position"in e){this.positionBuffer=n(l.ARRAY_BUFFER,new Float32Array(e.position),3)}else{}if("normal"in e){this.normalBuffer=n(l.ARRAY_BUFFER,new Float32Array(e.normal),3);s+=r}if("texture"in e){this.textureBuffer=n(l.ARRAY_BUFFER,new Float32Array(e.texture),2);s+=i}if("index"in e){this.indexBuffer=n(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(e.index),1);s+=a}if("color"in e){this.colorBuffer=n(l.ARRAY_BUFFER,new Float32Array(e.color),4);s+=o}this.draw=[function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data)}l.drawArraysInstanced(l.TRIANGLES,0,this.positionBuffer.numItems,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data)}l.drawArraysInstanced(l.TRIANGLES,0,this.positionBuffer.numItems,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindTextureAttribute(this.textureBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data)}l.drawArraysInstanced(l.TRIANGLES,0,this.positionBuffer.numItems,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindTextureAttribute(this.textureBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data)}l.drawArraysInstanced(l.TRIANGLES,0,this.positionBuffer.numItems,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}l.drawElementsInstanced(l.TRIANGLES,this.indexBuffer.numItems,l.UNSIGNED_SHORT,0,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}l.drawElementsInstanced(l.TRIANGLES,this.indexBuffer.numItems,l.UNSIGNED_SHORT,0,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindTextureAttribute(this.textureBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}l.drawElementsInstanced(l.TRIANGLES,this.indexBuffer.numItems,l.UNSIGNED_SHORT,0,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindTextureAttribute(this.textureBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}l.drawElementsInstanced(l.TRIANGLES,this.indexBuffer.numItems,l.UNSIGNED_SHORT,0,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindColorAttribute(this.colorBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data)}l.drawArraysInstanced(l.TRIANGLES,0,this.positionBuffer.numItems,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindColorAttribute(this.colorBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data)}l.drawArraysInstanced(l.TRIANGLES,0,this.positionBuffer.numItems,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindTextureAttribute(this.textureBuffer).bindColorAttribute(this.colorBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data)}l.drawArraysInstanced(l.TRIANGLES,0,this.positionBuffer.numItems,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindTextureAttribute(this.textureBuffer).bindColorAttribute(this.colorBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data)}l.drawArraysInstanced(l.TRIANGLES,0,this.positionBuffer.numItems,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindColorAttribute(this.colorBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}l.drawElementsInstanced(l.TRIANGLES,this.indexBuffer.numItems,l.UNSIGNED_SHORT,0,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindColorAttribute(this.colorBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}l.drawElementsInstanced(l.TRIANGLES,this.indexBuffer.numItems,l.UNSIGNED_SHORT,0,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindTextureAttribute(this.textureBuffer).bindColorAttribute(this.colorBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}l.drawElementsInstanced(l.TRIANGLES,this.indexBuffer.numItems,l.UNSIGNED_SHORT,0,this.instanceTransforms.count)}catch(t){}},function(){try{let t=m.getCurrentProgram();if(t.useShape(this)){t.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindTextureAttribute(this.textureBuffer).bindColorAttribute(this.colorBuffer).bindModelMatrixAttribute(this.instanceTransforms.buffer);l.bufferSubData(l.ARRAY_BUFFER,0,this.instanceTransforms.data);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}l.drawElementsInstanced(l.TRIANGLES,this.indexBuffer.numItems,l.UNSIGNED_SHORT,0,this.instanceTransforms.count)}catch(t){}}][s];return this};t.createInstanceTransforms=function(r){const n=4;const i=16;if(typeof r==="undefined"){r=1}if(typeof r==="number"||r.length===0){let n=[];for(let t=0,e=Math.max(1,r);t<e;++t){n.push(Float4x4.IDENTITY)}r=n}let a=r.length;let o={count:a,data:new Float32Array(a*i),matrices:[],buffer:function(){let t=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,t);l.bufferData(l.ARRAY_BUFFER,a*i*n,l.DYNAMIC_DRAW);return t}()};for(let e=0;e<a;++e){const s=e*i*n;let t=new Float32Array(o.data.buffer,s,i);o.matrices.push(t);Float4x4.copy(r[e],t)}return o};return t}();let p=s.Thing=function(){let t=r(s.CLASS_NAME_GENERATED);t.construct=function(t){this.node=t.node;this.update=t.update};t.updateAll=function(e){t.forEach(function(t){t.update(e)})};return t}();let E=s.TextFile=function(){let t=r(s.CLASS_NAME_REQUIRED);t.construct=function(e){if(typeof e.url==="undefined")throw"TextFile URL Required";let n=this;let r=new XMLHttpRequest;r.onload=function(t){if(r.status===200){n.text=r.responseText}if(typeof e.onReady!=="undefined"){e.onReady.notify(n)}};r.open("GET",e.url);r.send()};return t}();let I=s.ShapeBuilder=function(){let t=Object.create(null);t.construct=function(t){this.precision=t=typeof t!=="undefined"&&t!=null?t:7;this.vertexIndex=Object.create(null);this.vertices=[];this.faces=[];this.normals=[];this.texture=[];return this};t.addVertex=function(e){let n=Float3.str(e);if(n in this.vertexIndex){return this.vertexIndex[n]}else{let t=this.vertices.length;this.vertices.push(e);this.vertexIndex[n]=t;return t}};t.addVertexNormal=function(e,n){let r=Float3.str(e)+Float3.str(n);if(r in this.vertexIndex){return this.vertexIndex[r]}else{let t=this.vertices.length;this.vertices.push(e);this.normals.push(n);this.vertexIndex[r]=t;return t}};t.addVertexTexture=function(e,n){let r=Float3.str(e)+Float2.str(n);if(r in this.vertexIndex){return this.vertexIndex[r]}else{let t=this.vertices.length;this.vertices.push(e);this.texture.push(n);this.vertexIndex[r]=t;return t}};t.addVertexNormalTexture=function(e,n,r){let i=Float3.str(e)+Float3.str(n)+Float2.str(r);if(i in this.vertexIndex){return this.vertexIndex[i]}else{let t=this.vertices.length;this.vertices.push(e);this.normals.push(n);this.texture.push(r);this.vertexIndex[i]=t;return t}};t.addFace=function(t){this.faces.push(t)};t.makeBuffers=function(){let t={position:Utility.flatten(this.vertices),index:Utility.flatten(this.faces)};if(this.normals.length>0){t.normal=Utility.flatten(this.normals)}if(this.texture.length>0){t.texture=Utility.flatten(this.texture)}return t};t.makeFacets=function(){let s=[];let u=[];for(let o of this.faces){let t=this.vertices[o[0]];let e=this.vertices[o[1]];let n=this.vertices[o[2]];let r=Float3.normalize(Float3.subtract(e,t));let i=Float3.normalize(Float3.subtract(n,e));let a=Float3.cross(r,i);for(let t=0;t<o.length;++t){s.push(this.vertices[o[t]]);u.push(a)}}return{position:Utility.flatten(s),normal:Utility.flatten(u)}};t.new=function(t){return Object.create(I).construct(t)};return t}();let x=s.Primitive=function(){let t=Object.create(null);t.getShapeBuilder=function(){};t.makeFromBuilder=function(t,e){t=typeof t!=="undefined"&&t!=null?t:this.name;return _.new({buffers:function(){return e.makeFacets()}},t)};t.make=function(t){let e=this.getShapeBuilder();return this.makeFromBuilder(t,e)};return t}();let y=s.Tetrahedron=function(){let t=Object.create(x);t.name="tetrahedron";t.getShapeBuilder=function(){let t=I.new();t.addVertex([1,1,1]);t.addVertex([-1,1,-1]);t.addVertex([-1,-1,1]);t.addVertex([1,-1,-1]);t.addFace([0,1,2]);t.addFace([1,3,2]);t.addFace([2,3,0]);t.addFace([3,1,0]);return t};return t}();let F=s.Hexahedron=function(){let t=Object.create(x);t.name="cube";t.getShapeBuilder=function(){let t=I.new();t.addVertex([-1,-1,-1]);t.addVertex([-1,1,-1]);t.addVertex([1,1,-1]);t.addVertex([1,-1,-1]);t.addVertex([-1,-1,1]);t.addVertex([-1,1,1]);t.addVertex([1,1,1]);t.addVertex([1,-1,1]);t.addFace([0,1,2,0,2,3]);t.addFace([7,6,5,7,5,4]);t.addFace([1,5,6,1,6,2]);t.addFace([4,0,3,4,3,7]);t.addFace([4,5,1,4,1,0]);t.addFace([3,2,6,3,6,7]);return t};return t}();let M=s.Octahedron=function(){let t=Object.create(x);t.name="octahedron";t.getShapeBuilder=function(){let t=I.new();t.addVertex([0,1,0]);t.addVertex([1,0,0]);t.addVertex([0,0,1]);t.addVertex([-1,0,0]);t.addVertex([0,0,-1]);t.addVertex([0,-1,0]);t.addFace([0,2,1]);t.addFace([0,3,2]);t.addFace([0,4,3]);t.addFace([0,1,4]);t.addFace([5,1,2]);t.addFace([5,2,3]);t.addFace([5,3,4]);t.addFace([5,4,1]);return t};return t}();let g=s.Icosahedron=function(){let t=Object.create(x);t.name="icosahedron";t.getShapeBuilder=function(){let t=I.new();let e=(1+Math.sqrt(5))/2;let n=1/e;e=1;t.addVertex([-n,e,0]);t.addVertex([n,e,0]);t.addVertex([-n,-e,0]);t.addVertex([n,-e,0]);t.addVertex([0,-n,e]);t.addVertex([0,n,e]);t.addVertex([0,-n,-e]);t.addVertex([0,n,-e]);t.addVertex([e,0,-n]);t.addVertex([e,0,n]);t.addVertex([-e,0,-n]);t.addVertex([-e,0,n]);t.addFace([0,11,5]);t.addFace([0,5,1]);t.addFace([0,1,7]);t.addFace([0,7,10]);t.addFace([0,10,11]);t.addFace([1,5,9]);t.addFace([5,11,4]);t.addFace([11,10,2]);t.addFace([10,7,6]);t.addFace([7,1,8]);t.addFace([3,9,4]);t.addFace([3,4,2]);t.addFace([3,2,6]);t.addFace([3,6,8]);t.addFace([3,8,9]);t.addFace([4,9,5]);t.addFace([2,4,11]);t.addFace([6,2,10]);t.addFace([8,6,7]);t.addFace([9,8,1]);return t};return t}();let S=s.Square=function(){let t=Object.create(x);t.name="square";t.makeFromBuilder=function(t,e){t=typeof t!=="undefined"&&t!=null?t:this.name;return _.new({buffers:function(){return e.makeBuffers()}},t)};t.getShapeBuilder=function(){let t=I.new();t.addVertexNormalTexture([1,1,0],[0,0,1],[1,0]);t.addVertexNormalTexture([-1,1,0],[0,0,1],[0,0]);t.addVertexNormalTexture([-1,-1,0],[0,0,1],[0,1]);t.addVertexNormalTexture([1,-1,0],[0,0,1],[1,1]);t.addFace([0,1,2,0,2,3]);return t};return t}();let N=s.Sphere=function(){let t=Object.create(x);t.name="sphere";t.parameters={baseShapeBuilderType:g,subdivisions:4};t.getShapeBuilder=function(){let i=I.new();let a=function(t){return i.addVertex(Float3.normalize(t))};let e=this.parameters.baseShapeBuilderType.getShapeBuilder();for(let t of e.vertices){a(t)}let o=i.vertices;let s=i.faces=e.faces;let n=function(){let t=s.splice(0,1)[0];let e=a(Float3.add(o[t[0]],o[t[1]]));let n=a(Float3.add(o[t[1]],o[t[2]]));let r=a(Float3.add(o[t[2]],o[t[0]]));i.addFace([t[0],e,r]);i.addFace([t[1],n,e]);i.addFace([t[2],r,n]);i.addFace([e,n,r])};for(let t=0;t<this.parameters.subdivisions;++t){for(let t=0,e=s.length;t<e;++t){n()}}return i};t.makeFromBuilder=function(t,e){t=typeof t!=="undefined"&&t!=null?t:this.name;return _.new({buffers:function(){let t=e.makeBuffers();t.normal=t.position;return t}},t)};t.makeN=function(t){this.parameters.subdivisions=t;this.make(this.name+t)};return t}();let B=function(r){let i=r.length-1;let a=[];let o=function(t,e){let n=Float2.subtract(t,e);let r=Float2.perpendicular(n);a.push(Float2.normalize(r))};if(Float2.equals(r[0],r[i])){for(let n=0;n<=i;++n){let t=r[(n-1+i)%i];let e=r[(n+1)%i];o(t,e)}}else{for(let n=0;n<=i;++n){let t=r[n===0?n:n-1];let e=r[n===i?n:n+1];o(t,e)}}return a};let O=s.makeRevolve=function(t,r,T,R,p){let E=1e-6;let x=r.length-1;T=typeof T!=="undefined"&&T!=null?T:B(r);p=typeof p!=="undefined"&&p!=null?p:function(t){return t};return _.new({buffers:function(){let b=I.new();let n=-2*Math.PI/R;for(let A=0;A<R;++A){let f=A+1;let t=A*n,c=Math.cos(t),d=Math.sin(t);let e=f%R*n,h=Math.cos(e),m=Math.sin(e);for(let l=0;l<x;++l){let i=l+1;let a=r[l],o=T[l];let s=r[i],u=T[i];if(Float2.norm(Float2.subtract(a,s))>E){let t=(a[0]<E?0:2)+(s[0]<E?0:1);switch(t){case 0:break;case 1:{let t=b.addVertexNormalTexture([0,a[1],0],[o[0]*c,o[1],o[0]*d],[A/R,p(l/x)]);let e=b.addVertexNormalTexture([s[0]*c,s[1],s[0]*d],[u[0]*c,u[1],u[0]*d],[A/R,p(i/x)]);let n=b.addVertexNormalTexture([s[0]*h,s[1],s[0]*m],[u[0]*h,u[1],u[0]*m],[f/R,p(i/x)]);b.addFace([t,e,n]);break}case 2:{let t=b.addVertexNormalTexture([a[0]*c,a[1],a[0]*d],[o[0]*c,o[1],o[0]*d],[A/R,p(l/x)]);let e=b.addVertexNormalTexture([a[0]*h,a[1],a[0]*m],[o[0]*h,o[1],o[0]*m],[f/R,p(l/x)]);let n=b.addVertexNormalTexture([0,s[1],0],[u[0]*c,u[1],u[0]*d],[A/R,p(i/x)]);b.addFace([t,n,e]);break}case 3:{let t=b.addVertexNormalTexture([a[0]*c,a[1],a[0]*d],[o[0]*c,o[1],o[0]*d],[A/R,p(l/x)]);let e=b.addVertexNormalTexture([s[0]*c,s[1],s[0]*d],[u[0]*c,u[1],u[0]*d],[A/R,p(i/x)]);let n=b.addVertexNormalTexture([a[0]*h,a[1],a[0]*m],[o[0]*h,o[1],o[0]*m],[f/R,p(l/x)]);let r=b.addVertexNormalTexture([s[0]*h,s[1],s[0]*m],[u[0]*h,u[1],u[0]*m],[f/R,p(i/x)]);b.addFace([n,t,r,r,t,e]);break}}}}}return b.makeBuffers()}},t)};let v=s.makeBall=function(t,e){let r=[];let i=[];let a=Math.PI/e;for(let n=0;n<=e;++n){let t=a*n;let e=Float2.fixNum([Math.sin(t),Math.cos(t)]);r.push(e);i.push(e)}return O(t,r,i,e*2)};let L=s.makeSimpleExtrude=function(t,e,n,r,i){n=typeof n!=="undefined"&&n!=null?n:2;r=typeof r!=="undefined"&&r!=null?r:B(e);return _.new({buffers:function(){let f=I.new();let t=1e-6;let c=n/2;let d=e.length-1;for(let l=0;l<d;++l){let i=l+1;let a=e[l],o=r[l];let s=e[i],u=r[i];if(Float2.norm(Float2.subtract(a,s))>t){let t=f.addVertexNormalTexture([a[0],a[1],-c],[o[0],o[1],0],[0,l/d]);let e=f.addVertexNormalTexture([a[0],a[1],c],[o[0],o[1],0],[1,l/d]);let n=f.addVertexNormalTexture([s[0],s[1],-c],[u[0],u[1],0],[0,i/d]);let r=f.addVertexNormalTexture([s[0],s[1],c],[u[0],u[1],0],[1,i/d]);f.addFace([t,e,r,n,t,r])}}return f.makeBuffers()}},t)};return s};